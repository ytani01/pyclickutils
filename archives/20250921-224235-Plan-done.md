# 対話型CLIテストの計画

この計画は、`blessed`ライブラリを使用するのと同様に、個々のキー入力に応答する対話型CLIアプリケーションのテストを有効にするための`tests/conftest.py`の変更の概要を示します。

## 1. 目標

目標は、次のことができるテストフレームワークを作成することです。
- 擬似端末でCLIコマンドを実行する。
- 実行中のコマンドに一連のキー入力を送信する。
- インタラクションの各ステップでコマンドの出力を表明する。

## 2. 提案された実装

`tests/conftest.py`の`CLITestBase`クラスに`run_interactive_command`という新しいメソッドを追加します。このメソッドは、実行中のプロセスとの対話を可能にする`InteractiveSession`オブジェクトを返します。

### 2.1. `run_interactive_command` メソッド

このメソッドは`CLITestBase`に追加され、擬似端末でプロセスを起動する責任があります。

```python
import pty
import subprocess
import os

class CLITestBase:
    # ... 既存のメソッド ...

    def run_interactive_command(self, command: list[str]) -> "InteractiveSession":
        master_fd, slave_fd = pty.openpty()
        process = subprocess.Popen(
            command,
            stdin=slave_fd,
            stdout=slave_fd,
            stderr=slave_fd,
            close_fds=True,
        )
        os.close(slave_fd)
        return InteractiveSession(master_fd, process)
```

### 2.2. `InteractiveSession` クラス

この新しいクラスは、プロセスとの対話を管理します。

```python
import os
import select
import time

class InteractiveSession:
    def __init__(self, master_fd, process):
        self.master_fd = master_fd
        self.process = process
        self.output = ""

    def send_key(self, key: str):
        """プロセスにキー入力を送信します。"""
        os.write(self.master_fd, key.encode())

    def expect(self, pattern: str, timeout: int = 5) -> bool:
        """出力に特定のパターンが表示されるのを待ちます。"""
        start_time = time.time()
        while time.time() - start_time < timeout:
            r, _, _ = select.select([self.master_fd], [], [], 0.1)
            if r:
                try:
                    data = os.read(self.master_fd, 1024).decode()
                    self.output += data
                    if pattern in self.output:
                        return True
                except OSError:
                    break
        return False

    def get_output(self) -> str:
        """キャプチャされた出力を返します。"""
        return self.output

    def close(self):
        """プロセスを終了し、ファイル記述子を閉じます。"""
        self.process.terminate()
        self.process.wait()
        os.close(self.master_fd)

```

### 2.3. キー定数

テストを読みやすくするために、特別なキーの定数を定義します。

```python
# tests/conftest.py内
KEY_UP = "\x1b[A"
KEY_DOWN = "\x1b[B"
KEY_RIGHT = "\x1b[C"
KEY_LEFT = "\x1b[D"
KEY_ENTER = "\n"
```

## 3. 使用例

これは、新しいフレームワークを使用して単純な対話型メニューをテストする方法の例です。

```python
# テストファイル内
from tests.conftest import KEY_UP, KEY_DOWN, KEY_ENTER

def test_interactive_menu(cli_runner):
    session = cli_runner.run_interactive_command(["python", "my_interactive_app.py"])

    assert session.expect("メニュー項目1")
    session.send_key(KEY_DOWN)
    assert session.expect("メニュー項目2")
    session.send_key(KEY_ENTER)
    assert session.expect("メニュー項目2を選択しました")

    session.close()
```

## 4. 次のステップ

1.  `tests/conftest.py`に`run_interactive_command`メソッドと`InteractiveSession`クラスを実装します。
2.  `tests/conftest.py`にキー定数を追加します。
3.  機能を確認するために、使用例を含む新しいテストファイルを作成します。