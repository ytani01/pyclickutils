# リファクタリング計画

このドキュメントは、`click-utils` プロジェクトの全体的なリファクタリング計画を記述します。リファクタリングの目的は、コードの堅牢性、可読性、保守性を向上させることです。以下の項目を順次実施します。

## 1. `click_common_opts` デコレータの改善

### 1.1. バージョン文字列生成の堅牢化

- **現状**: `ver_str` が空の場合、`f"_._._ ({__package__} {__version__})"` という形式でバージョン文字列を生成している。`__package__` や `__version__` の取得に失敗した場合の挙動が不明瞭。
- **目標**: `click.version_option` の `version` 引数に直接 `__version__` を渡すことで、`click` 側でバージョン情報を適切に処理させる。または、`version.py` で取得したバージョン情報をより安全に利用する。
- **タスク**: `src/click_utils/click_utils.py` の `click_common_opts` 関数内のバージョン文字列生成ロジックを修正する。

## 2. `my_logger.py` の `get_logger` 関数の改善

### 2.1. ロガー名の生成方法の改善

- **現状**: `inspect.stack()` を使用してファイル名を取得し、ロガー名に付加している。これはスタックフレームに依存しており、予期せぬ動作を引き起こす可能性がある。
- **目標**: `name` 引数に渡される `__name__` をそのままロガー名として使用するか、より安全で一般的な方法でファイル名をログに含める。
- **タスク**: `src/click_utils/my_logger.py` の `get_logger` 関数内のロガー名生成ロジックを修正する。

### 2.2. ロガーハンドラの管理方法の改善

- **現状**: `logger.handlers.clear()` を使用して既存のハンドラをクリアしている。これはロガーの再設定時に予期せぬ副作用を引き起こす可能性がある。
- **目標**: ロガーはアプリケーションの起動時に一度だけ設定されるべきであるという原則に従い、ハンドラのクリアロジックを見直す。または、ロガーの重複を防ぐためのより適切なメカニズムを導入する。
- **タスク**: `src/click_utils/my_logger.py` の `get_logger` 関数内のハンドラ管理ロジックを修正する。

### 2.3. `debug` 引数の型チェックの簡素化

- **現状**: `debug` 引数の型チェックに `isinstance(debug, bool)` と `isinstance(debug, int)` を使用しているが、型ヒントと矛盾する可能性がある。
- **目標**: `debug` 引数を `bool` 型として扱い、型ヒントに沿ったシンプルなロジックにする。
- **タスク**: `src/click_utils/my_logger.py` の `get_logger` 関数内の `debug` 引数処理ロジックを修正する。

## 3. `__main__.py` のクリーンアップ

### 3.1. 冗長なコメントアウトされたコードの削除

- **現状**: `__main__.py` 内にコメントアウトされた `import pprint` やデバッグログのコードが存在する。
- **目標**: 不要なコメントアウトされたコードを削除し、コードの可読性を向上させる。
- **タスク**: `src/click_utils/__main__.py` から冗長なコメントアウトされたコードを削除する。

## 4. 全体的なコードスタイルとコメントの統一

### 4.1. 行長の統一

- **現状**: `GEMINI.md` のルール「各行を78文字以内に収めること」が一部の行で守られていない可能性がある。
- **目標**: すべてのPythonコードが78文字以内になるように修正する。
- **タスク**: プロジェクト全体のPythonファイルを対象に、行長を修正する。

### 4.2. コメント言語の統一

- **現状**: 日本語と英語のコメントが混在している。
- **目標**: すべてのコメントを日本語に統一する。
- **タスク**: プロジェクト全体のPythonファイルを対象に、コメントの言語を統一する。

## 実施順序

上記の項目は、以下の順序で実施することを推奨します。

1.  `__main__.py` のクリーンアップ (3.1)
2.  `my_logger.py` の `debug` 引数の型チェックの簡素化 (2.3)
3.  `my_logger.py` のロガー名の生成方法の改善 (2.1)
4.  `my_logger.py` のロガーハンドラの管理方法の改善 (2.2)
5.  `click_common_opts` デコレータのバージョン文字列生成の堅牢化 (1.1)
6.  全体的なコードスタイルとコメントの統一 (4.1, 4.2)

**注意**: リファクタリングの実行は、ユーザーの承認を得てから行います。各ステップの完了後には、リンティングとテストを実行して、コードの品質と動作を確認します。
